<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Details - KRUMVERSE</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 2.2em; margin: 0; }
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        .back-btn:hover {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
        }
        .content {
            padding: 40px;
        }
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .status-upcoming {
            background: #3498db;
            color: white;
        }
        .status-live {
            background: #e74c3c;
            color: white;
            animation: pulse 1.5s infinite;
        }
        .status-completed {
            background: #95a5a6;
            color: white;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .tournament-header {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .tournament-title {
            font-size: 2.5em;
            color: #333;
            margin: 15px 0;
        }
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .meta-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        .meta-label {
            font-size: 0.85em;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .meta-value {
            font-size: 1.3em;
            color: #333;
            font-weight: bold;
        }
        .fee-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
        }
        .fee-paid {
            background: #e74c3c;
            color: white;
        }
        .fee-free {
            background: #27ae60;
            color: white;
        }
        .section {
            margin-bottom: 40px;
        }
        .section-title {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .section-content {
            color: #555;
            line-height: 1.8;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 2px solid #667eea;
        }
        .btn-secondary:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #721c24;
        }
        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #0c5460;
        }
        .participants-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .participant-stat {
            text-align: center;
        }
        .participant-number {
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
        }
        .participant-label {
            color: #999;
            font-size: 0.9em;
            margin-top: 5px;
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .tournament-title { font-size: 1.8em; }
            .meta-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1 id="tournamentName">Tournament</h1>
                <div id="statusBadge" class="status-badge">Loading...</div>
            </div>
            <button class="back-btn" onclick="goBack()">‚Üê Back</button>
        </div>

        <div class="content" id="mainContent">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading tournament details...</p>
            </div>
        </div>
    </div>

    <script>
// ============================================
// CONFIGURATION
// ============================================
const API_BASE = 'http://localhost:5000/api';
const RAZORPAY_KEY_ID = 'rzp_test_Rdc0o3XDNefwT7';

let currentTournament = null;
let currentUser = null;
let autoStatusCheckInterval = null;

// ============================================
// AUTO STATUS CHECKER (Runs every 10 seconds)
// ============================================
function getAutoStatus(tournament) {
    const now = new Date();
    const startDate = new Date(tournament.startDate);
    const endDate = tournament.endDate ? new Date(tournament.endDate) : null;
    
    // Calculate tournament duration (default 2 hours if no end date)
    const duration = tournament.duration || (2 * 60 * 60 * 1000); // 2 hours in ms
    const tournamentEndTime = new Date(startDate.getTime() + duration);
    
    console.log('üìÖ Now:', now);
    console.log('üéÆ Start:', startDate);
    console.log('‚è±Ô∏è End (calculated):', tournamentEndTime);
    
    if (now < startDate) {
        return 'UPCOMING';
    } else if (now >= startDate && now < tournamentEndTime) {
        return 'LIVE';
    } else {
        return 'COMPLETED';
    }
}

function getStatusColor(status) {
    switch(status) {
        case 'UPCOMING': return 'status-upcoming';
        case 'LIVE': return 'status-live';
        case 'COMPLETED': return 'status-completed';
        default: return 'status-upcoming';
    }
}

function formatCountdown(date) {
    const now = new Date();
    const diff = new Date(date) - now;
    
    if (diff < 0) return 'Started';
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const mins = Math.floor((diff / 1000 / 60) % 60);
    
    if (days > 0) return `${days}d ${hours}h`;
    if (hours > 0) return `${hours}h ${mins}m`;
    return `${mins}m`;
}

// ============================================
// PAGE INITIALIZATION
// ============================================
window.addEventListener('DOMContentLoaded', () => {
    console.log('üéÆ Tournament Details Page Loaded');
    loadCurrentUser();
    
    const urlParams = new URLSearchParams(window.location.search);
    const tournamentId = urlParams.get('id');
    
    if (!tournamentId) {
        showError('No tournament ID provided');
        setTimeout(() => window.location.href = 'tournaments.html', 2000);
        return;
    }
    
    loadTournamentDetails(tournamentId);
    
    // Update status every 10 seconds
    autoStatusCheckInterval = setInterval(() => {
        if (currentTournament) {
            updateStatusDisplay();
        }
    }, 10000);
});

// ============================================
// LOAD CURRENT USER
// ============================================
function loadCurrentUser() {
    const userDataString = localStorage.getItem('user');
    if (userDataString) {
        try {
            currentUser = JSON.parse(userDataString);
            console.log('üë§ Current user:', currentUser.username);
        } catch (error) {
            console.error('Error parsing user data:', error);
        }
    }
}

// ============================================
// LOAD TOURNAMENT DETAILS
// ============================================
async function loadTournamentDetails(tournamentId) {
    try {
        const url = `${API_BASE}/tournaments/${tournamentId}`;
        console.log('üîó Fetching from:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch: ${response.status}`);
        }
        
        const responseData = await response.json();
        console.log('‚úÖ Tournament loaded:', responseData);
        
        if (responseData.success && responseData.data) {
            currentTournament = responseData.data;
            displayTournamentDetails();
        } else {
            throw new Error('Invalid response structure');
        }
        
    } catch (error) {
        console.error('‚ùå Error loading tournament:', error);
        showError('Failed to load tournament: ' + error.message);
        setTimeout(() => window.location.href = 'tournaments.html', 3000);
    }
}

// ============================================
// DISPLAY TOURNAMENT DETAILS
// ============================================
function displayTournamentDetails() {
    const tournament = currentTournament;
    const autoStatus = getAutoStatus(tournament);
    
    console.log('üé® Displaying tournament with status:', autoStatus);
    
    const startDate = new Date(tournament.startDate);
    const countdown = formatCountdown(tournament.startDate);
    
    let html = `
        <div class="tournament-header">
            <div class="tournament-title">${tournament.name || 'Tournament'}</div>
            
            <div class="meta-grid">
                <div class="meta-card">
                    <div class="meta-label">üéÆ Game</div>
                    <div class="meta-value">${tournament.game?.name || 'Unknown'}</div>
                </div>
                
                <div class="meta-card">
                    <div class="meta-label">üë§ Organizer</div>
                    <div class="meta-value">${tournament.organizer?.username || 'Unknown'}</div>
                </div>
                
                <div class="meta-card">
                    <div class="meta-label">üí∞ Fee</div>
                    <div class="meta-value">
                        ${tournament.registrationFee > 0 ? 
                            `<span class="fee-badge fee-paid">‚Çπ${tournament.registrationFee}</span>` : 
                            `<span class="fee-badge fee-free">FREE</span>`}
                    </div>
                </div>
                
                <div class="meta-card">
                    <div class="meta-label">üìÖ Start Date</div>
                    <div class="meta-value">${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString()}</div>
                </div>
                
                <div class="meta-card">
                    <div class="meta-label">üë• Participants</div>
                    <div class="meta-value">${tournament.participants?.length || 0}/${tournament.maxParticipants || '‚àû'}</div>
                </div>
                
                <div class="meta-card">
                    <div class="meta-label">üèÜ Prize Pool</div>
                    <div class="meta-value">${tournament.prizePool || 'Not specified'}</div>
                </div>
            </div>
        </div>
    `;
    
    // Description
    if (tournament.description) {
        html += `
            <div class="section">
                <div class="section-title">üìù Description</div>
                <div class="section-content">${tournament.description}</div>
            </div>
        `;
    }
    
    // Rules
    if (tournament.rules) {
        html += `
            <div class="section">
                <div class="section-title">üìã Rules & Guidelines</div>
                <div class="section-content">${tournament.rules}</div>
            </div>
        `;
    }
    
    // Participants Info
    html += `
        <div class="participants-info">
            <div class="participant-stat">
                <div class="participant-number">${tournament.participants?.length || 0}</div>
                <div class="participant-label">Registered Players</div>
            </div>
            <div class="participant-stat">
                <div class="participant-number">${tournament.maxParticipants || '‚àû'}</div>
                <div class="participant-label">Max Capacity</div>
            </div>
            <div class="participant-stat">
                <div class="participant-number">${countdown}</div>
                <div class="participant-label">Until Start</div>
            </div>
        </div>
    `;
    
    // Action Buttons
    html += '<div class="action-buttons">';
    
    if (autoStatus === 'COMPLETED') {
        html += '<button class="btn btn-secondary" disabled>‚úÖ Tournament Completed</button>';
    } else if (autoStatus === 'UPCOMING') {
        html += `
            <button class="btn btn-primary" onclick="handleJoinTournament()">
                üéÆ Register Now (Starts ${countdown})
            </button>
        `;
    } else if (autoStatus === 'LIVE') {
        html += `
            <button class="btn btn-primary" onclick="handleJoinTournament()">
                üî¥ LIVE - Join Now!
            </button>
        `;
    }
    
    html += `
        <button class="btn btn-secondary" onclick="goBack()">‚Üê Back to Tournaments</button>
    </div>
    `;
    
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = html;
    
    updateStatusDisplay();
}

// ============================================
// UPDATE STATUS DISPLAY
// ============================================
function updateStatusDisplay() {
    const autoStatus = getAutoStatus(currentTournament);
    const statusBadge = document.getElementById('statusBadge');
    
    if (statusBadge) {
        statusBadge.className = `status-badge ${getStatusColor(autoStatus)}`;
        statusBadge.textContent = autoStatus;
    }
    
    console.log('üìä Status updated:', autoStatus);
}

// ============================================
// JOIN TOURNAMENT
// ============================================
async function handleJoinTournament() {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('‚ùå Please login first');
        window.location.href = 'login.html';
        return;
    }
    
    const autoStatus = getAutoStatus(currentTournament);
    if (autoStatus === 'COMPLETED') {
        alert('‚ùå Tournament is completed');
        return;
    }
    
    try {
        console.log('üéØ Joining tournament:', currentTournament._id);
        
        const joinRes = await fetch(
            `${API_BASE}/tournaments/${currentTournament._id}/join`,
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            }
        );
        
        const joinData = await joinRes.json();
        console.log('üì§ Join Response:', joinData);
        
        if (!joinRes.ok) {
            alert('‚ùå Error: ' + joinData.message);
            return;
        }
        
        // Check if payment needed
        if (currentTournament.registrationFee > 0) {
            console.log('üí≥ Payment required');
            startPayment();
        } else {
            alert('‚úÖ Joined tournament successfully!');
            setTimeout(() => window.location.href = 'tournaments.html', 1500);
        }
        
    } catch (error) {
        console.error('‚ùå Error joining:', error);
        alert('Error: ' + error.message);
    }
}

// ============================================
// START PAYMENT
// ============================================
async function startPayment() {
    const token = localStorage.getItem('token');
    
    try {
        console.log('üí≥ Creating payment order...');
        
        const orderRes = await fetch(
            `${API_BASE}/tournaments/${currentTournament._id}/payment-order`,
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            }
        );
        
        const orderData = await orderRes.json();
        console.log('üì§ Order Response:', orderData);
        
        if (!orderRes.ok) {
            alert('‚ùå Payment failed: ' + orderData.message);
            return;
        }
        
        openRazorpayCheckout(orderData.data);
        
    } catch (error) {
        console.error('‚ùå Payment error:', error);
        alert('Payment error: ' + error.message);
    }
}

// ============================================
// RAZORPAY CHECKOUT
// ============================================
function openRazorpayCheckout(orderData) {
    console.log('üîì Opening Razorpay...');
    
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    
    const options = {
        key: RAZORPAY_KEY_ID,
        amount: orderData.amount,
        currency: 'INR',
        name: 'KRUMVERSE',
        description: `Registration - ${currentTournament.name}`,
        order_id: orderData.orderId,
        
        handler: function(response) {
            console.log('‚úÖ Payment successful!');
            verifyPayment(response);
        },
        
        prefill: {
            name: user.username || 'Player',
            email: user.email || 'player@krumverse.com'
        },
        
        theme: { color: '#667eea' }
    };
    
    try {
        new Razorpay(options).open();
    } catch (error) {
        console.error('‚ùå Razorpay error:', error);
        alert('Failed to open payment');
    }
}

// ============================================
// VERIFY PAYMENT
// ============================================
async function verifyPayment(paymentData) {
    const token = localStorage.getItem('token');
    
    try {
        console.log('üîê Verifying payment...');
        
        const verifyRes = await fetch(
            `${API_BASE}/tournaments/${currentTournament._id}/payment-verify`,
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    razorpayOrderId: paymentData.razorpay_order_id,
                    razorpayPaymentId: paymentData.razorpay_payment_id,
                    razorpaySignature: paymentData.razorpay_signature
                })
            }
        );
        
        const verifyData = await verifyRes.json();
        console.log('üì§ Verification Response:', verifyData);
        
        if (!verifyRes.ok) {
            alert('‚ùå Payment verification failed');
            return;
        }
        
        alert('‚úÖ Payment successful! Tournament joined!');
        setTimeout(() => window.location.href = 'tournaments.html', 1500);
        
    } catch (error) {
        console.error('‚ùå Verification error:', error);
        alert('Verification error: ' + error.message);
    }
}

// ============================================
// UTILITIES
// ============================================
function goBack() {
    window.location.href = 'tournaments.html';
}

function showError(msg) {
    const div = document.createElement('div');
    div.className = 'error-message';
    div.style.position = 'fixed';
    div.style.top = '20px';
    div.style.right = '20px';
    div.textContent = msg;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 4000);
}

window.addEventListener('beforeunload', () => {
    if (autoStatusCheckInterval) {
        clearInterval(autoStatusCheckInterval);
    }
});
    </script>
</body>
</html>